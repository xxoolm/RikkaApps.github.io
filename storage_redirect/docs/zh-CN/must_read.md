# 必读帮助

<!-- TOC depthFrom:2 depthTo:4 -->

- [1. 基本知识、用语说明](#1-基本知识用语说明)
- [2. 我们的理念](#2-我们的理念)
- [3. 最佳实践](#3-最佳实践)
    - [3.1. 了解开启存储空间隔离（重定向）会发生什么](#31-了解开启存储空间隔离重定向会发生什么)
    - [3.2. 了解影响应用正常使用的情况与解决方案](#32-了解影响应用正常使用的情况与解决方案)
    - [3.3. 相关选项](#33-相关选项)
- [4. 关于 Android Q](#4-关于-android-q)

<!-- /TOC -->

## 1. 基本知识、用语说明

注：此处用语说明以多数人所接受的习惯为准，说法各不相同，请阅读该文档时以此处解释为准。

对 Android 应用来说，它的数据主要存储在 “应用私有文件夹”（`/data/data`）和 “内置存储空间” （`/storage/emulated`）中。其中 “内置存储空间” 是提供给应用和用户的公共空间，拥有存储权限的应用可以在此自由读写文件，通过数据线连接至电脑后以 MTP 模式或大容量存储（4.x 以后已经弃用）模式打开手机存储所看到的也是这个 “内置存储空间”。

大多数手机/ROM 的 “内置存储空间” 根目录位置在 `/storage/emulated/<user id>`（user id 一般是 0，即主用户），在根目录下存在一些标准文件夹用于保存公共媒体文件和部分应用数据（包括游戏数据包之类），例如：

* 应用专用文件夹（`Android/data/应用包名`）：系统为应用设计位于内置存储的专用文件夹，里面可以保存数据、缓存等。在应用卸载或重新安装时会被清除数据。
* 闹铃（`Alarms`）
* 图片（`Pictures`）
* 相机保存的图片（`DCIM`）
* 文档（`Documents`）
* 下载（`Download`）
* 影片（`Movies`）
* 音乐（`Music`）
* 通知音（`Notifications`）
* 铃声（`Ringtones`）

还有其它由第三方 Android 系统所创建的标准文件夹（如 `bluetooth` 等），这里无法一一解释，标准文件夹的定义范围也可以由用户根据实际需要扩展。

定位存储空间中的文件的传统方式是使用 `file uri` —— 绝对路径（如 `file:///storage/emulated/0/test.txt`），但这种路径在 Android 7.0 开始不建议用于应用间交互（如分享图片、打开文档等将文件位置传给另一个应用去打开的交互）。现代 Android 更推荐使用通过 `content uri` —— 指向一个内容提供服务（`Content Provider`）的路径去发送文件内容给其它应用使用，否则会遇到一些问题，后面的章节将会提到。

## 2. 我们的理念

拥有存储权限的应用可以任意使用“内置存储空间”，即应用可以在“内置存储空间”读取任意文件或在任意位置写入文件。部分应用会在没有权限时拒绝工作或是应用的部分功能必须使用存储权限，很多情况下用户只能选择授予权限。

这意味着：

* 一些不重视用户体验的应用程序在使用存储空间时将应用各类私有数据随意保存，而用户主动保存的图片、音乐等文件又混入其中，使得用户在浏览、整理存储空间时获得很糟糕的体验。
* 用户无法控制应用可以读取哪些自己的文件。

我们希望：
* 应用在合理位置保存有用的文件（由用户保存的图片、文档等），同时它们又不能无条件在用户不知情的情况下访问个人文件。
* 对于应用原本四处保存的私有数据，应当能被正确地保存到 “应用专用文件夹” 当中，伴随着应用的卸载一同从内置存储中移除，释放出空间。

存储重定向以在对使用体验造成最小影响的前提下，让应用作出我们所期望的规范行为为理念设计。

## 3. 最佳实践

### 3.1. 了解开启存储空间隔离（重定向）会发生什么

打开了隔离存储之后，应用所访问的 “内置存储空间” 并不是真实的位置，而是在位于应用专用文件夹（`Android/data/<应用包名>`）内的一个文件夹。

例如：一个包名叫 `com.aaa.bbb` 的应用认为自己保存了一个图片在 `MyFile.jpg`，实际上这个图片被保存到了 `Android/data/com.aaa.bbb/sdcard/MyFile.jpg` 中。

除此以外，开启之后还会有以下影响：
1. 只能访问隔离存储空间和“可访问文件夹”中设定的文件夹
2. 隔离存储空间会随着应用的卸载而清除
3. 使用可能会遇到问题（参见 [4.2](#42-了解影响应用正常使用的情况与解决方案)）

### 3.2. 了解影响应用正常使用的情况与解决方案

会影响应用正常的情况基本都是涉及多个应用交互的情况，而且仅限直接传递文件路径的旧式应用。这些问题只会出现在设计不佳的应用上，随着时间推移，这类情况会越来越少。

以下举出一些具体例子，更多情况可以自己类比。

1. 直接传递文件路径
   
   * 无法从 QQ，WeChat 使用其他应用打开文件（标准方式传递文件路径）

     解决方案：启用“增强模式”中的“修复应用间交互”或建立“同步文件夹”规则并从弹出的通知中打开文件

   * 无法应用内发起安装 apk（标准方式传递文件路径）

     解决方案：启用“增强模式”中的“修复应用间交互”

   * 搜狗拼音直接发送图片到 QQ/WeChat（私有方式传递文件路径）

     解决方案：建立“共享文件夹”规则（“可访问文件夹”中的“来自其他应用的隔离存储空间”）

2. 应用无法在特定文件夹间移动文件

   * Bilibili 无法保存录制的视频 gif

     解决方案：使用“增强模式”中的“修复 rename”

3. 涉及 Xposed 模块（本质与 1 无异）
   
   一些 Xposed 模块采取直接在内置存储建立文件的方式用作保存配置的方式。文件会被不同进程读取。

   解决方案：建立“共享文件夹”规则（“可访问文件夹”中的“来自其他应用的隔离存储空间”）

### 3.3. 相关选项

尚未完成，请直接参考应用内说明。

## 4. 关于 Android Q

Android Q 的存储沙盒的实现本质与我们无异，这就意味着同样会遇到与我们一样的问题（参见 [3.2](#32-了解影响应用正常使用的情况与解决方案)）。

虽然应用为了在 Android Q 上正常工作必定会做出改变，但并非所有应用都会快速适配。要有非常好的体验就要求所有涉及的应用适配。在主流厂商升级到 Android Q 前，这显然不可能。另外 Android Q 的存储沙盒可以关闭，有些厂商可能会选择关闭也不是不可能。

因此，在相当长的一段时间内，我们的应用仍会是最佳方案。

* 2019/04/25 更新：Android Q 以后的下一个大版本才会为所有应用使用沙盒

  > In the upcoming Beta 3 release, apps that target Android 9 Pie (API level 28) or lower will see no change, by default, to how storage works from previous Android versions. 
  > 
  > Scoped Storage will be required in next year’s major platform release for all apps, independent of target SDK level.
  > 
  > [Android Developers Blog](https://android-developers.googleblog.com/2019/04/android-q-scoped-storage-best-practices.html)

  显然，大多数主流应用厂商在下一个大版本来临之前是不会主动适配的。