# 必讀幫助

<!-- TOC depthFrom:2 depthTo:4 -->

- [1. 基本知識、用語說明](#1-基本知識用語說明)
- [2. 我們的理念](#2-我們的理念)
- [3. 最佳實踐](#3-最佳實踐)
    - [3.1. 瞭解開啟儲存空間隔離（重新導向）會發生什麼](#31-瞭解開啟儲存空間隔離重新導向會發生什麼)
    - [3.2. 瞭解影響程式正常使用的情況與解決方案](#32-瞭解影響程式正常使用的情況與解決方案)
    - [3.3. 相關選項](#33-相關選項)
- [4. 關於 Android Q](#4-關於-android-q)

<!-- /TOC -->

## 1. 基本知識、用語說明

注：此處用語說明以多數人所接受的習慣為準，說法各不相同，請閱讀該文件時以此處解釋為準。

對 Android 程式來說，它的資料主要儲存在 「程式私有資料夾」（`/data/data`）和 「內建儲存空間」（`/storage/emulated`）中。其中 「內建儲存空間」 是提供給程式和使用者的公共空間，擁有儲存權限的程式可以在此自由讀寫檔案，通過資料線連線至電腦後以 MTP 模式或大容量儲存（4.x 以後已經棄用）模式開啟手機儲存所看到的也是這個 「內建儲存空間」。

大多數手機/ROM 的 「內建儲存空間」 根目錄位置在 `/storage/emulated/<user id>`（user id 一般是 0，即主使用者），在根目錄下存在一些標準資料夾用於儲存公共媒體檔案和部分程式資料（包括遊戲資料包之類），例如：

* 程式專用資料夾（`Android/data/程式包名`）：系統為程式設計位於內建儲存的專用資料夾，裡面可以儲存資料、快取等。在程式解除安裝或重新安裝時會被清除資料。
* 鬧鈴（`Alarms`）
* 圖片（`Pictures`）
* 相機儲存的圖片（`DCIM`）
* 文件（`Documents`）
* 下載（`Download`）
* 影片（`Movies`）
* 音樂（`Music`）
* 通知音（`Notifications`）
* 鈴聲（`Ringtones`）

還有其它由第三方 Android 系統所建立的標準資料夾（如 `bluetooth` 等），這裡無法一一解釋，標準資料夾的定義範圍也可以由使用者根據實際需要擴充套件。

定位儲存空間中的檔案的傳統方式是使用 `file uri` 絕對路徑（如 `file:///storage/emulated/0/test.txt`），但這種路徑在 Android 7.0 開始不建議用於程式間互動（如分享圖片、開啟文件等將檔案位置傳給另一個程式去開啟的互動）。現代 Android 更推薦使用通過 `content uri` —— 指向一個內容提供服務（`Content Provider`）的路徑去傳送檔案內容給其它程式使用，否則會遇到一些問題，後面的章節將會提到。

## 2. 我們的理念

擁有儲存權限的應用程式可以任意使用「內建儲存空間」，即應用程式可以在「內建儲存空間」讀取任意檔案或在任意位置寫入檔案。部分應用程式會在沒有權限時拒絕工作或是應用程式的部分功能必須使用儲存權限，很多情況下使用者只能選擇授予權限。

這意味著：

* 一些不重視使用者體驗的應用程式程式在使用儲存空間時將應用程式各類私有資料隨意儲存，而使用者主動儲存的圖片、音樂等檔案又混入其中，使得使用者在瀏覽、整理儲存空間時獲得很糟糕的體驗。
* 使用者無法控制應用程式可以讀取哪些自己的檔案。

我們希望：
* 應用程式在合理位置儲存有用的檔案（由使用者儲存的圖片、文件等），同時它們又不能無條件在使用者不知情的情況下訪問個人檔案。
* 對於應用程式原本四處儲存的私有資料，應當能被正確地儲存到 「應用程式專用資料夾」 當中，伴隨著應用程式的解除安裝一同從內建儲存中移除，釋放出空間。

儲存重定向以在對使用體驗造成最小影響的前提下，讓應用程式作出我們所期望的規範行為為理念設計。

## 3. 最佳實踐

### 3.1. 瞭解開啟儲存空間隔離（重新導向）會發生什麼

打開了隔離儲存之後，程式所訪問的 「內建儲存空間」 並不是真實的位置，而是在位於程式專用資料夾（`Android/data/程式包名`）內的一個資料夾。

例如：一個包名叫 `com.aaa.bbb` 的程式認為自己儲存了一個圖片在 `MyFile.jpg`，實際上這個圖片被儲存到了 `Android/data/com.aaa.bbb/sdcard/MyFile.jpg` 中。

除此以外，開啟之後還會有以下影響：
1. 只能訪問隔離儲存空間和「可訪問資料夾」中設定的資料夾
2. 隔離儲存空間會隨著程式的解除安裝而清除
3. 使用可能會遇到問題（參見 [4.2](#42-瞭解影響程式正常使用的情況與解決方案)）

### 3.2. 瞭解影響程式正常使用的情況與解決方案

會影響程式正常的情況基本都是涉及多個程式互動的情況，而且僅限直接傳遞檔案路徑的舊式程式。這些問題只會出現在設計不佳的程式上，隨著時間推移，這類情況會越來越少。

以下舉出一些具體例子，更多情況可以自己類比。

1. 直接傳遞檔案路徑
   
   * 無法從 QQ，WeChat 使用其他程式開啟檔案（標準方式傳遞檔案路徑）

     解決方案：啟用「增強模式」中的「修復程式間互動」或建立「同步資料夾」規則並從彈出的通知中開啟檔案

   * 無法程式內發起安裝 apk（標準方式傳遞檔案路徑）

     解決方案：啟用「增強模式」中的「修復程式間互動」

   * 搜狗拼音直接傳送圖片到 QQ/WeChat（私有方式傳遞檔案路徑）

     解決方案：建立「共享資料夾」規則（「可訪問資料夾」中的「來自其他程式的隔離儲存空間」）

2. 程式無法在特定資料夾間移動檔案

   * Bilibili 無法保存錄制的視訊 gif

     解決方案：使用「增強模式」中的「修復 rename」

3. 涉及 Xposed 模組（本質與 1 無異）
   
   一些 Xposed 模組採取直接在內建儲存建立檔案的方式用作儲存配置的方式。檔案會被不同程序讀取。

   解決方案：建立「共享資料夾」規則（「可訪問資料夾」中的「來自其他程式的隔離儲存空間」）

### 3.3. 相關選項

尚未完成，請直接參考程式內說明。

## 4. 關於 Android Q

Android Q 的儲存沙盒的實現本質與我們無異，這就意味著同樣會遇到與我們一樣的問題（參見 [3.2](#32-瞭解影響程式正常使用的情況與解決方案)）。

雖然程式為了在 Android Q 上正常工作必定會做出改變，但並非所有程式都會快速適配。要有非常好的體驗就要求所有涉及的程式適配。在主流廠商升級到 Android Q 前，這顯然不可能。另外 Android Q 的儲存沙盒可以關閉，有些廠商可能會選擇關閉也不是不可能。

因此，在相當長的一段時間內，我們的程式仍會是最佳方案。

* 2019/04/25 更新：Android Q 以後的下一個大版本才會為所有應用程式使用沙盒

  > In the upcoming Beta 3 release, apps that target Android 9 Pie (API level 28) or lower will see no change, by default, to how storage works from previous Android versions. 
  > 
  > Scoped Storage will be required in next year’s major platform release for all apps, independent of target SDK level.
  > 
  > [Android Developers Blog](https://android-developers.googleblog.com/2019/04/android-q-scoped-storage-best-practices.html)

  顯然，大多數主流應用程式廠商在下一個大版本來臨之前是不會主動適配的。
